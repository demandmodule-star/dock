# This GitHub Actions workflow automates the process of building the application,
# creating a release package, and publishing it to GitHub Releases.

name: Create Release

on:
  release:
    types: [published] # Trigger when a release is published on the GitHub UI


jobs:
  build-and-release:
    runs-on: windows-latest # Use a Windows runner because we are building a .exe
    permissions:
      contents: write # This is required to create a release and upload assets
      packages: read # Not strictly needed now, but good practice
      actions: read # Not strictly needed now, but good practice

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 packaging

      - name: Update version in dock.py
        run: |
          # Get the version from the tag (e.g., v1.2.3 -> 1.2.3)
          $version = "${{ github.event.release.tag_name }}".Substring(1)
          (Get-Content dock.py) -replace '__version__ = ".*"', "__version__ = `"$version`"" | Set-Content dock.py

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed --icon=app.ico --clean dock.py

      - name: Package release assets
        run: |
          # Copy the executable from the 'dist' folder to the root
          copy dist\dock.exe .
          powershell -command "Compress-Archive -Path 'dock.exe', 'app.ico' -DestinationPath 'DynamicDockWidget_Win_x86_64.zip'"

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./DynamicDockWidget_Win_x86_64.zip
          asset_name: DynamicDockWidget_Win_x86_64.zip
          asset_content_type: application/zip